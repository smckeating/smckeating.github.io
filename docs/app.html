<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>EMS Health App ver 0.1</title>
        <link rel="stylesheet" href="web.css">
        <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
        
        <style>
          .vertical-list {
            list-style-type: none;
            padding: 0;
          }
          .vertical-list li {
            margin-bottom: 5px;
          }
        </style>
    </head>
<body>

<div id="app">
  <div v-if="error">
    <p>Error encountered.</p>
  </div>
  <div v-else>
  <h1>{{ title }}</h1>
  <nav>
    <button @click="currentTab = 'Patient'">Patient</button>
    <button @click="currentTab = 'Problems'">Problems</button>
    <button @click="currentTab = 'Medications'">Medications</button>
    <button @click="currentTab = 'Vitals'">Vitals</button>
  </nav>
  </div>
  <div class="content" v-if="error">
    <p>Please (re)launch the app by clicking <a :href="homePageUrl">here</a>.</p>  
  </div>
  <div v-else-if="!loading">
    <div v-if="currentTab === 'Patient'">
      <h2>Patient</h2>
      <ul class="vertical-list">
        <li>Name: {{ patientData ? patientData.name.find(name => name.use === 'official').text : '' }}</li>
        <li>Age: {{ patientData ? calculateAge(patientData.birthDate) : '' }}</li>
        <li>Gender: {{ patientData ? patientData.gender : '' }}</li>
        <li>Height: {{ demographics.height }}</li>
        <li>Weight: {{ demographics.weight }}</li>
        <li>Allergies: {{ demographics.allergies }}</li>
        <li>Allergies:</li>
        <li v-for="allergy in allergies">
            <p><strong>Substance:</strong> {{ allergy.substance?.coding[0]?.display }}</p>
            <p><strong>Reaction:</strong> {{ allergy.reaction.map(reaction => reaction.manifestation[0]?.coding[0]?.display).join(', ') }}</p>
            <p><strong>Last Occurrence:</strong> {{ allergy.lastOccurrence }}</p>
            <p><strong>Severity:</strong> {{ allergy.severity }}</p>
        </li>
        <li>Language: {{ patientData && patientData.communication ? patientData.communication.find(lang => lang.preferred === true).language.coding[0].display : ''  }}</li>
        <li>{{ patientData }}</li>
        <li>{{ allergies }}</li>
      </ul>
    </div>
    <div v-if="currentTab === 'Problems'">
      <h2>Problems</h2>
      <ul class="vertical-list">
        <li>Problem list: {{ problems }}</li>
      </ul>
    </div>
    <div v-if="currentTab === 'Medications'">
      <h2>Medications</h2>
      <ul class="vertical-list">
        <li>Medication list: {{ medications }}</li>
      </ul>
    </div>
    <div v-if="currentTab === 'Vitals'">
      <h2>Vitals</h2>
      <ul class="vertical-list">
        <li>Vitals list: {{ vitals }}</li>
      </ul>
    </div>
  </div>
  <div v-else>
    <p>Loading...</p>
  </div>
</div>

<script>
new Vue({
  el: '#app',
  data: {
    title: 'EMS Health App',
    currentTab: 'Patient',
    loading: true,
    error: false,
    homePageUrl: 'https://smckeating.github.io/index.html',
    demographics: {
      name: 'John Doe',
      age: 35,
      gender: 'Male',
      height: '6\'0"',
      weight: '180 lbs',
      allergies: 'Peanuts, Pollen',
      language: 'English'
    },
    patientData: null,
    allergies: [],
    problems: [],
    medications: [],
    vitals: []
  },
  mounted() {
    FHIR.oauth2.ready()
      .then(client => {
        return Promise.all([
            client.request(`Patient/${client.patient.id}`),
            client.request(`AllergyIntolerance?patient=${client.patient.id}`),
            client.request(`Condition?patient=${client.patient.id}`),
            client.request(`MedicationRequest?patient=${client.patient.id}`),
            client.request(`Observation?patient=${client.patient.id}&category=vital-signs`)
        ]);
      })
      .then(([patientData, allergies, conditions, medications, observations]) => {
        this.patientData = patientData;
        this.allergies = allergies.entry.map(entry => entry.resource);
        this.problems = conditions.entry.map(entry => entry.resource);
        this.medications = medications.entry.map(entry => entry.resource);
        this.vitals = observations.entry.map(entry => entry.resource);
        this.loading = false;
      })
      .catch(error => {
          console.error("Error:", error);
          this.loading = false;
          this.error = true;
      });
  },
methods: {
    calculateAge(birthDate) {
        const today = new Date();
        const dob = new Date(birthDate);
        let age = today.getFullYear() - dob.getFullYear();
        const diffMonths = today.getMonth() - dob.getMonth();
        if (dob.getMonth() > today.getMonth() || (dob.getMonth() === today.getMonth() && today.getDate() < dob.getDate())) {
            age = age - 1;
        }
        return age;
    }
}
});
</script>

</body>
</html>
